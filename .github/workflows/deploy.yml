name: Deploy Resume to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Validation job - checks files before deployment
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate file structure
        run: |
          echo "üîç Validating file structure..."

          # Check critical files exist
          for file in "index.html" "resume/index.html" "resume/zh/index.html" \
                      "assets/css/style.css" "assets/js/script.js" \
                      "assets/js/data-config.js" "assets/js/data-config-zh.js" \
                      "assets/js/data-repos.js"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing required file: $file"
              exit 1
            fi
            echo "‚úÖ Found: $file"
          done

          echo ""
          echo "‚úÖ All required files present!"

      - name: Validate JSON data files
        run: |
          echo "üîç Validating JSON data files..."

          # Check JSON syntax
          for file in "assets/data/config.json" "assets/data/config-zh.json" "assets/data/repos.json"; do
            if [ -f "$file" ]; then
              if python3 -m json.tool "$file" > /dev/null 2>&1; then
                echo "‚úÖ Valid JSON: $file"
              else
                echo "‚ùå Invalid JSON: $file"
                exit 1
              fi
            fi
          done

          echo ""
          echo "‚úÖ All JSON files valid!"

      - name: Check JavaScript syntax
        run: |
          echo "üîç Checking JavaScript files..."

          # Basic check that JS files are not empty
          for file in assets/js/*.js; do
            if [ -s "$file" ]; then
              size=$(wc -c < "$file")
              echo "‚úÖ $file (${size} bytes)"
            else
              echo "‚ùå Empty file: $file"
              exit 1
            fi
          done

          echo ""
          echo "‚úÖ All JavaScript files valid!"

  # Deployment job - runs after validation
  deploy:
    needs: validate
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Display deployment info
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üéâ Deployment successful!"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          echo "üìç Your resume is now live at:"
          echo "   English: ${{ steps.deployment.outputs.page_url }}"
          echo "   Chinese: ${{ steps.deployment.outputs.page_url }}zh/"
          echo ""
          echo "‚è±Ô∏è  Changes may take 1-2 minutes to appear"
          echo "üí° Clear browser cache if you don't see updates"
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
